<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로또명당 커넥트 | 우리 동네 1등 찾기</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ffc107;
            --dark-color: #212529;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
        }

        header {
            background-color: var(--dark-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
        }

        .search-container {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            background: white;
            border-bottom: 1px solid #ddd;
        }

        input[type="text"] {
            padding: 10px;
            width: 60%;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background-color: #e5ac00;
        }

        #map {
            width: calc(70vh - 126px);
            height: calc(50vh - 90px);
            min-height: 200px;
            margin: 0 auto;
        }

        .info-window {
            padding: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-window b {
            color: #d32f2f;
        }

        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #eee;
            text-align: center;
            padding: 10px 0;
            font-size: 12px;
            color: #666;
            z-index: 100;
        }

        @media (max-width: 600px) {
            header {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 1rem;
            }

            header h1 {
                font-size: 1.2rem;
                color: var(--primary-color); /* 색상 재지정 */
            }

            .search-container {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"] {
                width: auto; /* Let it stretch */
                max-width: none;
            }

            #map {
                width: calc(84vh);
                height: 60vh; 
                min-height: 250px;
                margin: 0 auto;
            }
        }

        #store-list-container {
            max-width: 800px; /* Optional: Constrain width for better readability */
            margin: 20px auto; /* Center the container and add some space */
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #store-list-container h2 {
            text-align: center;
            color: var(--dark-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        #store-list-container ol {
            list-style-type: decimal; /* Use decimal numbering for ranks */
            padding-left: 20px; /* Add padding for numbers */
            margin: 0;
        }

        #store-list-container li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
            color: #333;
        }

        #store-list-container li:last-child {
            border-bottom: none; /* No border for the last item */
        }

        #store-list-container .no-results {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        @media (max-width: 600px) {
            #store-list-container {
                margin: 10px;
                padding: 10px;
            }
            #store-list-container li {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>로또명당 커넥트 | 우리 동네 1등 찾기</h1>
    <button onclick="location.href='index.html'" style="padding: 10px 20px; background-color: #ffc107; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">로또 추첨기</button>
</header>

<div class="search-container">
    <input type="text" id="keyword" placeholder="동네나 지역명을 입력하세요 (예: 강남역)">
    <button onclick="searchPlaces()">검색</button>
</div>

<div id="map"></div>
<div id="store-list-container"></div>

<footer>
    과도한 몰입은 금물, 로또는 소액으로 즐거운 상상을 위해 구매하세요.
</footer>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d41f0e241cc682fab66fcc67acd12e90&libraries=services&autoload=false"></script>
<script>
// 전역 변수로 마커 배열 선언
var currentMarkers = [];

// kakao.maps.load를 사용하여 SDK 로드가 완료된 후 지도 초기화
kakao.maps.load(function() {
    // Custom distance calculation function (Haversine formula)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const φ1 = lat1 * Math.PI/180; // φ, λ in radians
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c; // in metres
    }

    var mapContainer = document.getElementById('map'), 
        mapOption = { 
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 기본 서울 시청
            level: 3 
        }; 

    var map = new kakao.maps.Map(mapContainer, mapOption); 
    var ps = new kakao.maps.services.Places(); 
    var infowindow = new kakao.maps.InfoWindow({zIndex:1});

    // 검색 함수를 window 객체에 할당하여 전역에서 접근 가능하게 함
    window.searchPlaces = function() {
        var keyword = document.getElementById('keyword').value;

        if (!keyword.replace(/^\s+|\s+$/g, '')) {
            alert('지역명을 입력해주세요!');
            return false;
        }
        
        ps.keywordSearch(keyword + ' 로또', placesSearchCB); 
    }

    // 장소검색이 완료됐을 때 호출되는 콜백함수
    function placesSearchCB(data, status, pagination) {
        console.log("Search Status:", status);
        console.log("Search Data:", data);
        console.log("Search Pagination:", pagination);

        // Clear previous store list and markers
        const storeListContainer = document.getElementById('store-list-container');
        storeListContainer.innerHTML = ''; 
        
        // Remove existing markers from the map before adding new ones
        if (typeof currentMarkers !== 'undefined') {
            for (let i = 0; i < currentMarkers.length; i++) {
                currentMarkers[i].setMap(null);
            }
        }
        currentMarkers = []; // Reset marker array


        if (status === kakao.maps.services.Status.OK) {
            var bounds = new kakao.maps.LatLngBounds();

            // Calculate distance to map center and sort
            const mapCenter = map.getCenter();
            data.forEach(place => {
                place.distance = getDistance(mapCenter.getLat(), mapCenter.getLng(), parseFloat(place.y), parseFloat(place.x));
            });

            data.sort((a, b) => a.distance - b.distance);

            // Display top 10 stores
            const top10Stores = data.slice(0, 10);

            if (top10Stores.length > 0) {
                const title = document.createElement('h2');
                title.textContent = '가까운 로또 명당 TOP 10';
                storeListContainer.appendChild(title);

                const ol = document.createElement('ol');
                top10Stores.forEach((place, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}위: ${place.place_name} (${(place.distance / 1000).toFixed(2)} km)`;
                    ol.appendChild(li);

                    // Display marker for each of the top 10 stores
                    const marker = displayMarker(place);
                    currentMarkers.push(marker); // Add marker to the list
                    bounds.extend(new kakao.maps.LatLng(place.y, place.x));
                });
                storeListContainer.appendChild(ol);
                map.setBounds(bounds); // Adjust map bounds to fit the top 10
            } else {
                storeListContainer.innerHTML = '<p class="no-results">검색 결과가 존재하지 않습니다.</p>';
                map.setCenter(mapCenter); // Re-center map if no results
            }

        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            storeListContainer.innerHTML = '<p class="no-results">검색 결과가 존재하지 않습니다.</p>';
            map.setCenter(mapCenter); // Re-center map if no results
            alert('검색 결과가 존재하지 않습니다.'); // Keep alert for direct user feedback
            return;
        } else if (status === kakao.maps.services.Status.ERROR) {
            storeListContainer.innerHTML = '<p class="no-results">검색 중 오류가 발생했습니다.</p>';
            map.setCenter(mapCenter); // Re-center map if error
            alert('검색 중 오류가 발생했습니다.'); // Keep alert for direct user feedback
            return;
        } else {
            storeListContainer.innerHTML = '<p class="no-results">알 수 없는 오류가 발생했습니다.</p>';
            map.setCenter(mapCenter); // Re-center map if unknown error
            alert('알 수 없는 오류가 발생했습니다. (상태 코드: ' + status + ')'); // Keep alert for direct user feedback
        }
    }

    // 마커를 표시하는 함수
    function displayMarker(place) {
        var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x) 
        });

        kakao.maps.event.addListener(marker, 'click', function() {
            var content = '<div class="info-window">' + 
                          '<b>' + place.place_name + '</b><br>' +
                          place.address_name + '<br>' +
                          '<a href="https://map.kakao.com/link/to/' + place.id + '" target="_blank" style="color:blue">길찾기</a>' +
                          '</div>';
            infowindow.setContent(content);
            infowindow.open(map, marker);
        });
    }
});
</script>
</body>
</html>
